{% extends 'base.html' %}

{% block title %}Nueva Hospedada - Sistema de Gestión Hotelera{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-bed"></i> Nueva Hospedada</h1>
    <p class="mb-0">Registrar nueva hospedada de cliente</p>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-plus-circle"></i> Información de la Hospedada
                </h5>
            </div>
            <div class="card-body">
                <form id="formNuevaHospedada">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tipo de Hospedada <span class="text-danger">*</span></label>
                            <select name="tipo_hospedada" class="form-select" required>
                                {% for value, label in tipos_hospedada %}
                                <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Número de Huéspedes</label>
                            <input type="number" name="numero_huespedes" class="form-control" value="1" min="1" max="10">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Fecha de Entrada <span class="text-danger">*</span></label>
                            <input type="date" name="fecha_entrada" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Fecha de Salida</label>
                            <input type="date" name="fecha_salida" class="form-control">
                            <small class="text-muted">Dejar vacío para hospedada indefinida</small>
                        </div>
                    </div>

                    <!-- Cliente -->
                    <div class="mb-3">
                        <label class="form-label">Cliente <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="text" name="cliente_search" class="form-control" placeholder="Buscar cliente por nombre o documento..." autocomplete="off">
                            <button type="button" class="btn btn-outline-primary" onclick="nuevoCliente()">
                                <i class="fas fa-user-plus"></i> Nuevo
                            </button>
                        </div>
                        <input type="hidden" name="cliente_id" required>
                        <div id="clientes-results" class="list-group position-absolute w-100" style="z-index: 1000; display: none;"></div>
                        <div id="cliente-selected" class="mt-2" style="display: none;">
                            <div class="alert alert-info">
                                <strong>Cliente seleccionado:</strong>
                                <span id="cliente-info"></span>
                                <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="limpiarCliente()">
                                    <i class="fas fa-times"></i> Cambiar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Empresa (opcional) -->
                    <div class="mb-3">
                        <label class="form-label">Empresa (Opcional)</label>
                        <div class="input-group">
                            <input type="text" name="empresa_search" class="form-control" placeholder="Buscar empresa..." autocomplete="off">
                            <button type="button" class="btn btn-outline-primary" onclick="nuevaEmpresa()">
                                <i class="fas fa-building"></i> Nueva
                            </button>
                        </div>
                        <input type="hidden" name="empresa_id">
                        <div id="empresas-results" class="list-group position-absolute w-100" style="z-index: 1000; display: none;"></div>
                        <div id="empresa-selected" class="mt-2" style="display: none;">
                            <div class="alert alert-success">
                                <strong>Empresa seleccionada:</strong>
                                <span id="empresa-info"></span>
                                <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="limpiarEmpresa()">
                                    <i class="fas fa-times"></i> Quitar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Habitación -->
                    <div class="mb-3">
                        <label class="form-label">Habitación <span class="text-danger">*</span></label>
                        <select name="habitacion_id" class="form-select" required disabled>
                            <option value="">Seleccione fechas primero...</option>
                        </select>
                        <small class="text-muted">Las habitaciones disponibles se cargarán según las fechas seleccionadas</small>
                    </div>

                    <!-- Observaciones -->
                    <div class="mb-3">
                        <label class="form-label">Observaciones</label>
                        <textarea name="observaciones" class="form-control" rows="3" placeholder="Comentarios adicionales..."></textarea>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{% url 'hotel:hospedadas' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Volver
                        </a>
                        <button type="submit" class="btn btn-primary" disabled>
                            <i class="fas fa-save"></i> Crear Hospedada
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Información de ayuda -->
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-info-circle"></i> Información
                </h6>
            </div>
            <div class="card-body">
                <h6>Tipos de Hospedada:</h6>
                <ul class="small">
                    <li><strong>Continua:</strong> Hospedada por días completos</li>
                    <li><strong>Por Rato:</strong> Hospedada por horas</li>
                </ul>

                <h6 class="mt-3">Notas Importantes:</h6>
                <ul class="small">
                    <li>La fecha de entrada es obligatoria</li>
                    <li>Si no especifica fecha de salida, será hospedada indefinida</li>
                    <li>El sistema verificará disponibilidad automáticamente</li>
                    <li>Si la entrada es hoy, la habitación se marcará como ocupada</li>
                </ul>
            </div>
        </div>

        <!-- Resumen -->
        <div class="card mt-3" id="resumen-hospedada" style="display: none;">
            <div class="card-header bg-primary text-white">
                <h6 class="card-title mb-0">
                    <i class="fas fa-calculator"></i> Resumen
                </h6>
            </div>
            <div class="card-body">
                <div id="resumen-contenido">
                    <!-- Se llenará dinámicamente -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modales para crear cliente y empresa (similares a los de reservas) -->
<!-- Modal nuevo cliente -->
<div class="modal fade" id="modalNuevoCliente" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus"></i> Nuevo Cliente
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formNuevoCliente">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nombre <span class="text-danger">*</span></label>
                            <input type="text" name="nombre" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Apellido <span class="text-danger">*</span></label>
                            <input type="text" name="apellido" class="form-control" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tipo de Documento</label>
                            <select name="tipo_documento" class="form-select">
                                <option value="dni">DNI</option>
                                <option value="pasaporte">Pasaporte</option>
                                <option value="cedula">Cédula</option>
                                <option value="rfc">RFC</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Número de Documento <span class="text-danger">*</span></label>
                            <input type="text" name="numero_documento" class="form-control" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Teléfono</label>
                            <input type="tel" name="telefono" class="form-control">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" name="email" class="form-control">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Dirección</label>
                        <textarea name="direccion" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Crear Cliente
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal nueva empresa -->
<div class="modal fade" id="modalNuevaEmpresa" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-building"></i> Nueva Empresa
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formNuevaEmpresa">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label">Nombre de la Empresa <span class="text-danger">*</span></label>
                            <input type="text" name="nombre" class="form-control" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">RFC <span class="text-danger">*</span></label>
                            <input type="text" name="rfc" class="form-control" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Teléfono <span class="text-danger">*</span></label>
                            <input type="tel" name="telefono" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email <span class="text-danger">*</span></label>
                            <input type="email" name="email" class="form-control" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Dirección <span class="text-danger">*</span></label>
                        <textarea name="direccion" class="form-control" rows="2" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Contacto</label>
                        <input type="text" name="contacto" class="form-control" placeholder="Nombre del contacto">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Crear Empresa
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Funciones similares a las de reservas pero adaptadas para hospedadas
$(document).ready(function() {
    // Establecer fecha mínima como hoy
    const today = new Date().toISOString().split('T')[0];
    $('input[name="fecha_entrada"]').attr('min', today).val(today);

    // Cargar habitaciones cuando cambien las fechas
    $('input[name="fecha_entrada"], input[name="fecha_salida"]').on('change', cargarHabitacionesDisponibles);

    // Validar formulario
    $('#formNuevaHospedada input[required], #formNuevaHospedada select[required]').on('change', validarFormulario);
});

// Búsqueda de clientes
let timeoutCliente;
$('input[name="cliente_search"]').on('keyup', function() {
    const query = $(this).val();
    clearTimeout(timeoutCliente);

    if (query.length >= 2) {
        timeoutCliente = setTimeout(() => buscarClientes(query), 300);
    } else {
        $('#clientes-results').hide();
    }
});

// Búsqueda de empresas
let timeoutEmpresa;
$('input[name="empresa_search"]').on('keyup', function() {
    const query = $(this).val();
    clearTimeout(timeoutEmpresa);

    if (query.length >= 2) {
        timeoutEmpresa = setTimeout(() => buscarEmpresas(query), 300);
    } else {
        $('#empresas-results').hide();
    }
});

function buscarClientes(query) {
    $.get(`/api/buscar-cliente/?q=${encodeURIComponent(query)}`)
        .done(function(data) {
            const results = $('#clientes-results');
            results.empty();

            if (data.clientes.length > 0) {
                data.clientes.forEach(cliente => {
                    results.append(`
                        <a href="#" class="list-group-item list-group-item-action" onclick="seleccionarCliente(${cliente.id}, '${cliente.nombre_completo}', '${cliente.numero_documento}')">
                            <strong>${cliente.nombre_completo}</strong><br>
                            <small class="text-muted">${cliente.numero_documento}</small>
                        </a>
                    `);
                });
                results.show();
            } else {
                results.hide();
            }
        });
}

function buscarEmpresas(query) {
    $.get(`/api/buscar-empresa/?q=${encodeURIComponent(query)}`)
        .done(function(data) {
            const results = $('#empresas-results');
            results.empty();

            if (data.empresas.length > 0) {
                data.empresas.forEach(empresa => {
                    results.append(`
                        <a href="#" class="list-group-item list-group-item-action" onclick="seleccionarEmpresa(${empresa.id}, '${empresa.nombre}', '${empresa.rfc}')">
                            <strong>${empresa.nombre}</strong><br>
                            <small class="text-muted">${empresa.rfc}</small>
                        </a>
                    `);
                });
                results.show();
            } else {
                results.hide();
            }
        });
}

function seleccionarCliente(id, nombre, documento) {
    $('input[name="cliente_id"]').val(id);
    $('input[name="cliente_search"]').val('');
    $('#clientes-results').hide();
    $('#cliente-info').text(`${nombre} - ${documento}`);
    $('#cliente-selected').show();
    validarFormulario();
}

function seleccionarEmpresa(id, nombre, rfc) {
    $('input[name="empresa_id"]').val(id);
    $('input[name="empresa_search"]').val('');
    $('#empresas-results').hide();
    $('#empresa-info').text(`${nombre} - ${rfc}`);
    $('#empresa-selected').show();
}

function limpiarCliente() {
    $('input[name="cliente_id"]').val('');
    $('input[name="cliente_search"]').val('');
    $('#cliente-selected').hide();
    validarFormulario();
}

function limpiarEmpresa() {
    $('input[name="empresa_id"]').val('');
    $('input[name="empresa_search"]').val('');
    $('#empresa-selected').hide();
}

function cargarHabitacionesDisponibles() {
    const fechaEntrada = $('input[name="fecha_entrada"]').val();
    const fechaSalida = $('input[name="fecha_salida"]').val();

    if (!fechaEntrada) return;

    const select = $('select[name="habitacion_id"]');
    select.prop('disabled', true).html('<option value="">Cargando habitaciones...</option>');

    let url = `/api/habitaciones-disponibles/?fecha_entrada=${fechaEntrada}`;
    if (fechaSalida) {
        url += `&fecha_salida=${fechaSalida}`;
    }

    $.get(url)
        .done(function(data) {
            select.empty();

            if (data.habitaciones.length > 0) {
                select.append('<option value="">Seleccione una habitación...</option>');
                data.habitaciones.forEach(hab => {
                    select.append(`
                        <option value="${hab.id}">
                            Habitación ${hab.numero} - ${hab.tipo} ($${hab.precio}/noche)
                        </option>
                    `);
                });
                select.prop('disabled', false);
            } else {
                select.append('<option value="">No hay habitaciones disponibles</option>');
            }
            validarFormulario();
        })
        .fail(function() {
            select.html('<option value="">Error al cargar habitaciones</option>');
        });
}

function validarFormulario() {
    const clienteId = $('input[name="cliente_id"]').val();
    const habitacionId = $('select[name="habitacion_id"]').val();
    const fechaEntrada = $('input[name="fecha_entrada"]').val();

    const valido = clienteId && habitacionId && fechaEntrada;
    $('#formNuevaHospedada button[type="submit"]').prop('disabled', !valido);
}

function nuevoCliente() {
    $('#modalNuevoCliente').modal('show');
}

function nuevaEmpresa() {
    $('#modalNuevaEmpresa').modal('show');
}

// Envío del formulario
$('#formNuevaHospedada').on('submit', function(e) {
    e.preventDefault();

    const formData = {
        tipo_hospedada: $('select[name="tipo_hospedada"]').val(),
        cliente_id: $('input[name="cliente_id"]').val(),
        empresa_id: $('input[name="empresa_id"]').val() || null,
        habitacion_id: $('select[name="habitacion_id"]').val(),
        fecha_entrada: $('input[name="fecha_entrada"]').val(),
        fecha_salida: $('input[name="fecha_salida"]').val() || null,
        numero_huespedes: $('input[name="numero_huespedes"]').val(),
        observaciones: $('textarea[name="observaciones"]').val()
    };

    const submitBtn = $(this).find('button[type="submit"]');
    submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Creando...');

    $.ajax({
        url: '{% url "hotel:hospedada_create" %}',
        method: 'POST',
        data: JSON.stringify(formData),
        contentType: 'application/json',
        success: function(response) {
            if (response.success) {
                Swal.fire({
                    title: '¡Hospedada creada!',
                    text: `Hospedada ${response.hospedada.numero_hospedada} creada exitosamente`,
                    icon: 'success',
                    confirmButtonText: 'Ir a hospedadas'
                }).then(() => {
                    window.location.href = '{% url "hotel:hospedadas" %}';
                });
            } else {
                Swal.fire('Error', response.error, 'error');
                submitBtn.prop('disabled', false).html('<i class="fas fa-save"></i> Crear Hospedada');
            }
        },
        error: function() {
            Swal.fire('Error', 'Error al crear la hospedada', 'error');
            submitBtn.prop('disabled', false).html('<i class="fas fa-save"></i> Crear Hospedada');
        }
    });
});

// Formularios de cliente y empresa
$('#formNuevoCliente').on('submit', function(e) {
    e.preventDefault();
    // Implementar creación de cliente
    Swal.fire('Info', 'Funcionalidad de crear cliente en desarrollo', 'info');
});

$('#formNuevaEmpresa').on('submit', function(e) {
    e.preventDefault();
    // Implementar creación de empresa
    Swal.fire('Info', 'Funcionalidad de crear empresa en desarrollo', 'info');
});
</script>
{% endblock %}