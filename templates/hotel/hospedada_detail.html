{% extends 'base.html' %}

{% block title %}Hospedada {{ hospedada.numero_hospedada }} - Sistema de Gesti√≥n Hotelera{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <div>
        <h1><i class="fas fa-calendar-check"></i> Hospedada {{ hospedada.numero_hospedada }}</h1>
        <p class="mb-0">Detalle completo de la hospedada</p>
    </div>
    <div>
        {% if hospedada.estado == 'confirmada' %}
        <button class="btn btn-success me-2" onclick="checkIn()">
            <i class="fas fa-sign-in-alt"></i> Check-in
        </button>
        {% endif %}
        {% if hospedada.estado == 'en_curso' %}
        <button class="btn btn-warning me-2" onclick="checkOut()">
            <i class="fas fa-sign-out-alt"></i> Check-out
        </button>
        {% endif %}
        <a href="{% url 'hotel:generar_factura' hospedada.id %}" class="btn btn-primary" target="_blank">
            <i class="fas fa-file-invoice"></i> Generar Factura
        </a>
    </div>
</div>

<!-- Alerta de deuda si existe -->
{% if hospedada.tiene_deuda %}
<div class="alert alert-danger mb-4">
    <h5><i class="fas fa-exclamation-triangle"></i> Esta hospedada tiene una deuda pendiente</h5>
    <div class="row mt-3">
        <div class="col-md-3">
            <strong>Monto de la deuda:</strong><br>
            <span class="fs-4">${{ hospedada.monto_deuda|floatformat:2 }}</span>
        </div>
        <div class="col-md-3">
            <strong>Deudor:</strong><br>
            {% if hospedada.deudor == 'empresa' %}
                <span class="badge bg-info">Empresa: {{ hospedada.empresa.nombre }}</span>
            {% else %}
                <span class="badge bg-warning">Cliente: {{ hospedada.cliente.nombre_completo }}</span>
            {% endif %}
        </div>
        <div class="col-md-3">
            <strong>Fecha de checkout:</strong><br>
            {{ hospedada.fecha_checkout|date:"d/m/Y H:i" }}
        </div>
        <div class="col-md-3">
            <strong>Estado:</strong><br>
            <span class="badge bg-danger">Pendiente de pago</span>
        </div>
    </div>
    {% if hospedada.observaciones_deuda %}
    <div class="mt-3">
        <strong>Observaciones:</strong> {{ hospedada.observaciones_deuda }}
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Informaci√≥n principal -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-user"></i> Informaci√≥n del Cliente</h5>
            </div>
            <div class="card-body">
                <h5>{{ hospedada.cliente.nombre_completo }}</h5>
                <p class="mb-1"><strong>Documento:</strong> {{ hospedada.cliente.get_tipo_documento_display }} - {{ hospedada.cliente.numero_documento }}</p>
                {% if hospedada.cliente.telefono %}
                <p class="mb-1"><strong>Tel√©fono:</strong> {{ hospedada.cliente.telefono }}</p>
                {% endif %}
                {% if hospedada.cliente.email %}
                <p class="mb-1"><strong>Email:</strong> {{ hospedada.cliente.email }}</p>
                {% endif %}
                {% if hospedada.cliente.direccion %}
                <p class="mb-0"><strong>Direcci√≥n:</strong> {{ hospedada.cliente.direccion }}</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-bed"></i> Informaci√≥n de la Hospedada</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <p class="mb-1"><strong>Habitaci√≥n:</strong></p>
                        <span class="badge bg-info fs-6">{{ hospedada.habitacion.numero }}</span>
                        <p class="small">{{ hospedada.habitacion.tipo.nombre }}</p>
                    </div>
                    <div class="col-6">
                        <p class="mb-1"><strong>Estado:</strong></p>
                        <span class="badge 
                            {% if hospedada.estado == 'pendiente' %}bg-warning
                            {% elif hospedada.estado == 'confirmada' %}bg-info
                            {% elif hospedada.estado == 'en_curso' %}bg-success
                            {% elif hospedada.estado == 'finalizada' %}bg-secondary
                            {% else %}bg-danger{% endif %} fs-6">
                            {{ hospedada.get_estado_display }}
                        </span>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-6">
                        <p class="mb-1"><strong>Entrada:</strong> {{ hospedada.fecha_entrada|date:"d/m/Y" }}</p>
                        <p class="mb-1"><strong>Salida:</strong> 
                            {% if hospedada.fecha_salida %}
                                {{ hospedada.fecha_salida|date:"d/m/Y" }}
                                {% if hospedada.estado == 'en_curso' %}
                                <button class="btn btn-sm btn-outline-primary ms-2" onclick="abrirModalExtender()">
                                    <i class="fas fa-calendar-plus"></i> Extender
                                </button>
                                {% endif %}
                            {% else %}
                                <span class="badge bg-warning">Indefinida</span>
                                {% if hospedada.estado == 'en_curso' %}
                                <button class="btn btn-sm btn-outline-success ms-2" onclick="abrirModalDefinirSalida()">
                                    <i class="fas fa-calendar-check"></i> Definir Salida
                                </button>
                                {% endif %}
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-6">
                        <p class="mb-1"><strong>Noches:</strong> 
                            {% if hospedada.fecha_salida %}
                                {{ hospedada.dias_estancia }}
                            {% else %}
                                <span class="text-muted">Por definir</span>
                            {% endif %}
                        </p>
                        <p class="mb-1"><strong>Hu√©spedes:</strong> {{ hospedada.numero_huespedes }}</p>
                    </div>
                </div>
                {% if hospedada.observaciones %}
                <hr>
                <p class="mb-0"><strong>Observaciones:</strong><br>{{ hospedada.observaciones }}</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Resumen financiero -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-calculator"></i> Resumen Financiero</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-2">
                        <div class="border rounded p-3">
                            <h4 class="text-primary">${{ hospedada.precio_total|floatformat:2 }}</h4>
                            <p class="mb-0">Habitaci√≥n</p>
                            <small class="text-muted">
                                {% if hospedada.fecha_salida %}
                                    {{ hospedada.dias_estancia }} noches
                                {% else %}
                                    Indefinida
                                {% endif %}
                            </small>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="border rounded p-3">
                            <h4 class="text-info">${{ total_consumos|floatformat:2 }}</h4>
                            <p class="mb-0">Consumos</p>
                            <small class="text-muted">{{ consumos|length }} productos</small>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="border rounded p-3">
                            <h4 class="{% if hospedada.subtotal_ajustes >= 0 %}text-success{% else %}text-danger{% endif %}">${{ hospedada.subtotal_ajustes|floatformat:2 }}</h4>
                            <p class="mb-0">Ajustes</p>
                            <small class="text-muted">
                                <button class="btn btn-sm btn-outline-primary" onclick="abrirModalAjustes()">
                                    <i class="fas fa-plus"></i> Gestionar
                                </button>
                            </small>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="border rounded p-3">
                            <h4 class="text-dark">${{ hospedada.total_con_ajustes|floatformat:2 }}</h4>
                            <p class="mb-0">Total</p>
                            <small class="text-muted">Con ajustes</small>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="border rounded p-3">
                            <h4 class="text-success">${{ total_pagado|floatformat:2 }}</h4>
                            <p class="mb-0">Pagado</p>
                            <small class="text-muted">{{ pagos|length }} pagos</small>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="border rounded p-3">
                            <h4 class="{% if hospedada.saldo_pendiente > 0 %}text-danger{% else %}text-success{% endif %}">
                                ${{ hospedada.saldo_pendiente|floatformat:2 }}
                            </h4>
                            <p class="mb-0">Pendiente</p>
                            <small class="text-muted">
                                {% if hospedada.saldo_pendiente > 0 %}Por pagar{% else %}Pagado{% endif %}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Consumos -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-shopping-cart"></i> Consumos ({{ consumos|length }})</h5>
                <a href="{% url 'hotel:agregar_consumo' hospedada.id %}" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-plus"></i> Agregar Consumo
                </a>
            </div>
            <div class="card-body p-0">
                {% if consumos %}
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th>Fecha/Hora</th>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Precio Unit.</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for consumo in consumos %}
                            <tr>
                                <td>{{ consumo.fecha_consumo|date:"d/m/Y H:i" }}</td>
                                <td>{{ consumo.producto.nombre }}</td>
                                <td class="text-center">{{ consumo.cantidad }}</td>
                                <td>${{ consumo.precio_unitario|floatformat:2 }}</td>
                                <td><strong>${{ consumo.subtotal|floatformat:2 }}</strong></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="table-light">
                                <td colspan="4" class="text-end"><strong>Total Consumos:</strong></td>
                                <td><strong>${{ total_consumos|floatformat:2 }}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-shopping-cart fa-2x text-muted mb-2"></i><br>
                    <p class="text-muted mb-0">No hay consumos registrados</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-credit-card"></i> Pagos ({{ pagos|length }})</h5>
                <a href="{% url 'hotel:agregar_pago' hospedada.id %}" class="btn btn-outline-success btn-sm">
                    <i class="fas fa-plus"></i> Agregar Pago
                </a>
            </div>
            <div class="card-body p-0">
                {% if pagos %}
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>M√©todo</th>
                                <th>Monto</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pago in pagos %}
                            <tr>
                                <td>{{ pago.fecha_pago|date:"d/m/Y" }}</td>
                                <td>
                                    <small>{{ pago.get_metodo_pago_display }}</small><br>
                                    <span class="badge bg-secondary">{{ pago.get_tipo_pago_display }}</span>
                                </td>
                                <td><strong>${{ pago.monto|floatformat:2 }}</strong></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="table-light">
                                <td colspan="2" class="text-end"><strong>Total:</strong></td>
                                <td><strong>${{ total_pagado|floatformat:2 }}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-credit-card fa-2x text-muted mb-2"></i><br>
                    <p class="text-muted mb-0">No hay pagos registrados</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Servicios -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-concierge-bell"></i> Servicios Adicionales ({{ servicios|length }})</h5>
                <button class="btn btn-outline-primary btn-sm" onclick="abrirModalServicios()">
                    <i class="fas fa-plus"></i> Agregar Servicio
                </button>
            </div>
            <div class="card-body p-0">
                {% if servicios %}
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th>Fecha/Hora</th>
                                <th>Servicio</th>
                                <th>Cantidad</th>
                                <th>Precio Unit.</th>
                                <th>Subtotal</th>
                                <th>Observaciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for servicio in servicios %}
                            <tr>
                                <td>{{ servicio.fecha_servicio|date:"d/m/Y H:i" }}</td>
                                <td>{{ servicio.tipo_servicio.nombre }}</td>
                                <td>{{ servicio.cantidad }}</td>
                                <td>${{ servicio.precio|floatformat:2 }}</td>
                                <td><strong>${{ servicio.subtotal|floatformat:2 }}</strong></td>
                                <td>{{ servicio.observaciones|default:"-" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="table-light">
                                <td colspan="4" class="text-end"><strong>Total Servicios:</strong></td>
                                <td colspan="2"><strong>${{ total_servicios|floatformat:2 }}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-concierge-bell fa-2x text-muted mb-2"></i><br>
                    <p class="text-muted mb-0">No hay servicios adicionales registrados</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Acciones Requeridas -->
{% if hospedada.saldo_pendiente > 0 %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Acciones Requeridas</h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h6 class="text-danger mb-2">
                            <i class="fas fa-money-bill-wave"></i> Saldo Pendiente: ${{ hospedada.saldo_pendiente|floatformat:2 }}
                        </h6>
                        <p class="mb-0 text-muted">
                            Esta reserva tiene un saldo pendiente de pago. Se recomienda procesar el pago para completar la transacci√≥n.
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="btn-group" role="group">
                            <a href="{% url 'hotel:agregar_pago' hospedada.id %}" class="btn btn-outline-success">
                                <i class="fas fa-plus"></i> Agregar Pago
                            </a>
                            <button type="button" class="btn btn-success" onclick="pagarTodo()">
                                <i class="fas fa-money-bill"></i> Pagar Todo
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
console.log('üöÄ JavaScript NUEVO - Sin modales - V2.0 - {% now "Y-m-d H:i:s" %}');

// FUNCI√ìN PAGAR TODO
function pagarTodo() {
    const saldoPendiente = parseFloat('{{ hospedada.saldo_pendiente|floatformat:2 }}');
    
    if (typeof Swal !== 'undefined') {
        Swal.fire({
            title: 'Pagar Todo',
            html: '√Ç≈ºConfirmar el pago completo de <strong>$' + saldoPendiente.toFixed(2) + '</strong>?<br><br>' +
                  '<small class="text-muted">Ser√° redirigido a la p√°gina de pago con el monto preestablecido.</small>',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'S√≠, pagar todo',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#28a745'
        }).then((result) => {
            if (result.isConfirmed) {
                // Redirigir a agregar pago con par√°metro para pagar todo
                window.location.href = '{% url "hotel:agregar_pago" hospedada.id %}?pagar_todo=1';
            }
        });
    } else {
        if (confirm('√Ç≈ºConfirmar el pago completo de $' + saldoPendiente.toFixed(2) + '?')) {
            window.location.href = '{% url "hotel:agregar_pago" hospedada.id %}?pagar_todo=1';
        }
    }
}

// FUNCIONES DE CHECK-IN/CHECK-OUT
function checkIn() {
    if (typeof Swal !== 'undefined') {
        Swal.fire({
            title: 'Check-in',
            text: '¬øConfirmar el check-in de esta reserva?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'S√≠, confirmar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                alert('‚úÖ Check-in confirmado\nLa habitaci√≥n est√° ahora ocupada');
                location.reload();
            }
        });
    } else {
        if (confirm('¬øConfirmar el check-in de esta reserva?')) {
            alert('‚úÖ Check-in confirmado');
            location.reload();
        }
    }
}

function checkOut() {
    // Mostrar modal de checkout con opciones
    $('#modalCheckout').modal('show');
    
    // Actualizar informaci√≥n del saldo en el modal
    const saldoPendiente = parseFloat('{{ hospedada.saldo_pendiente|floatformat:2 }}');
    const tieneEmpresa = {% if hospedada.empresa %}true{% else %}false{% endif %};
    
    document.getElementById('saldoPendienteCheckout').textContent = '$' + saldoPendiente.toFixed(2);
    
    if (saldoPendiente > 0) {
        document.getElementById('opcionesCheckout').style.display = 'block';
        document.getElementById('sinDeudaCheckout').style.display = 'none';
        
        // Mostrar opci√≥n de qui√©n paga solo si hay empresa
        if (tieneEmpresa) {
            document.getElementById('opcionDeudor').style.display = 'block';
        } else {
            document.getElementById('opcionDeudor').style.display = 'none';
            document.getElementById('deudorCheckout').value = 'cliente';
        }
    } else {
        document.getElementById('opcionesCheckout').style.display = 'none';
        document.getElementById('sinDeudaCheckout').style.display = 'block';
    }
}

function procesarCheckout() {
    const saldoPendiente = parseFloat('{{ hospedada.saldo_pendiente|floatformat:2 }}');
    let accion = 'sin_deuda';
    let deudor = 'cliente';
    let metodoPago = 'efectivo';
    let observacionesDeuda = '';
    
    if (saldoPendiente > 0) {
        accion = document.querySelector('input[name="accionCheckout"]:checked').value;
        deudor = document.getElementById('deudorCheckout').value;
        metodoPago = document.getElementById('metodoPagoCheckout').value;
        observacionesDeuda = document.getElementById('observacionesDeuda').value;
    }
    
    const data = {
        accion: accion,
        deudor: deudor,
        metodo_pago: metodoPago,
        observaciones_deuda: observacionesDeuda
    };
    
    fetch('{% url "hotel:hospedada_checkout" hospedada.id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            $('#modalCheckout').modal('hide');
            Swal.fire({
                title: 'Checkout Exitoso',
                text: data.mensaje,
                icon: 'success',
                confirmButtonText: 'OK'
            }).then(() => {
                location.reload();
            });
        } else {
            Swal.fire('Error', data.error, 'error');
        }
    })
    .catch(error => {
        Swal.fire('Error', 'Error al procesar el checkout', 'error');
    });
}

// FUNCIONES DE SERVICIOS
function abrirModalServicios() {
    $('#modalServicios').modal('show');
    cargarTiposServicio();
}

function cargarTiposServicio() {
    fetch('{% url "hotel:api_tipos_servicio" %}')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('tipo_servicio_id');
            select.innerHTML = '<option value="">Seleccione un servicio...</option>';
            
            data.tipos.forEach(tipo => {
                const option = document.createElement('option');
                option.value = tipo.id;
                option.textContent = tipo.nombre;
                option.setAttribute('data-precio', tipo.precio_sugerido || 0);
                option.setAttribute('data-requiere-precio', tipo.requiere_precio);
                select.appendChild(option);
            });
            
            // Actualizar precio sugerido al cambiar servicio
            select.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const precioSugerido = parseFloat(selectedOption.getAttribute('data-precio')) || 0;
                document.getElementById('precio_servicio').value = precioSugerido;
            });
        })
        .catch(error => {
            console.error('Error cargando tipos de servicio:', error);
        });
}

function agregarServicio() {
    const tipoServicioId = document.getElementById('tipo_servicio_id').value;
    const cantidad = document.getElementById('cantidad_servicio').value;
    const precio = document.getElementById('precio_servicio').value;
    const observaciones = document.getElementById('observaciones_servicio').value;
    
    if (!tipoServicioId || !cantidad || !precio) {
        Swal.fire('Error', 'Por favor complete todos los campos requeridos', 'error');
        return;
    }
    
    const data = {
        hospedada_id: {{ hospedada.id }},
        tipo_servicio_id: tipoServicioId,
        cantidad: cantidad,
        precio: precio,
        observaciones: observaciones
    };
    
    fetch('{% url "hotel:api_agregar_servicio" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            $('#modalServicios').modal('hide');
            Swal.fire({
                title: 'Servicio Agregado',
                text: data.message,
                icon: 'success',
                confirmButtonText: 'OK'
            }).then(() => {
                location.reload();
            });
        } else {
            Swal.fire('Error', data.message, 'error');
        }
    })
    .catch(error => {
        Swal.fire('Error', 'Error al agregar el servicio', 'error');
    });
}

// CONFIGURACI√ìN DE EVENTOS
document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ DOM cargado, configurando eventos de reserva detail...');
    
    // Evento selecci√≥n de producto
    var selectProducto = document.getElementById('producto_id');
    if (selectProducto) {
        selectProducto.addEventListener('change', function() {
            var selectedOption = this.options[this.selectedIndex];
            var precio = parseFloat(selectedOption.getAttribute('data-precio')) || 0;
            var stock = parseInt(selectedOption.getAttribute('data-stock')) || 0;
            
            console.log('üì¶ Producto seleccionado:', selectedOption.textContent, 'Precio:', precio, 'Stock:', stock);
            
            document.getElementById('precio_unitario_display').value = '$' + precio.toFixed(2);
            document.getElementById('stock_disponible').value = stock + ' unidades';
            document.getElementById('precio_producto').value = precio;
            document.getElementById('stock_producto').value = stock;
            
            calcularSubtotal();
        });
    }
    
    // Evento cantidad
    var cantidadInput = document.getElementById('cantidad_consumo');
    if (cantidadInput) {
        cantidadInput.addEventListener('input', calcularSubtotal);
    }
    
    // Evento b√∫squeda con debounce
    var timeoutBusqueda;
    var buscarInput = document.getElementById('buscarProducto');
    if (buscarInput) {
        buscarInput.addEventListener('input', function() {
            clearTimeout(timeoutBusqueda);
            timeoutBusqueda = setTimeout(function() {
                cargarTodosLosProductos();
            }, 500);
        });
    }
    
    // Evento tipo de pago (autocompletar monto)
    var tipoPagoSelect = document.getElementById('tipo_pago');
    if (tipoPagoSelect) {
        tipoPagoSelect.addEventListener('change', function() {
            if (this.value === 'pago_total') {
                var montoInput = document.getElementById('monto');
                if (montoInput) {
                    montoInput.value = SALDO_PENDIENTE.toFixed(2);
                }
            }
        });
    }
    
    console.log('‚úÖ Todos los eventos configurados correctamente');
    console.log('üéØ Variables globales:', {
        API_URL: API_URL,
        RESERVA_ID: RESERVA_ID,
        SALDO_PENDIENTE: SALDO_PENDIENTE
    });
});

console.log('‚úÖ JavaScript de reserva detail cargado completamente - Sin errores');

// Funciones para extender/definir fecha de salida
function abrirModalExtender() {
    document.getElementById('textoTitulo').textContent = 'Extender Reserva';
    document.getElementById('textoBoton').textContent = 'Extender Reserva';
    
    // Establecer fecha m√≠nima como la fecha actual de salida + 1 d√≠a
    const fechaActual = '{{ hospedada.fecha_salida|date:"Y-m-d" }}';
    const fechaMinima = new Date(fechaActual);
    fechaMinima.setDate(fechaMinima.getDate() + 1);
    document.getElementById('nueva_fecha_salida').min = fechaMinima.toISOString().split('T')[0];
    
    $('#modalExtenderReserva').modal('show');
}

function abrirModalDefinirSalida() {
    document.getElementById('textoTitulo').textContent = 'Definir Fecha de Salida';
    document.getElementById('textoBoton').textContent = 'Definir Salida';
    
    // Establecer fecha m√≠nima como ma√±ana
    const fechaMinima = new Date();
    fechaMinima.setDate(fechaMinima.getDate() + 1);
    document.getElementById('nueva_fecha_salida').min = fechaMinima.toISOString().split('T')[0];
    
    $('#modalExtenderReserva').modal('show');
}

function guardarExtension() {
    const nuevaFecha = document.getElementById('nueva_fecha_salida').value;
    
    if (!nuevaFecha) {
        showNotification('warning', 'Fecha requerida', 'Por favor seleccione una fecha de salida');
        return;
    }

    const data = {
        hospedada_id: {{ hospedada.id }},
        fecha_salida: nuevaFecha
    };
    
    showLoading();
    $.post('{% url "hotel:api_extender_hospedada" %}', JSON.stringify(data), 'json')
    .done(function(response) {
        if (response.success) {
            showNotification('success', '√âxito', 'La reserva se ha actualizado correctamente');
            $('#modalExtenderReserva').modal('hide');
            // Recargar la p√°gina para mostrar los cambios
            setTimeout(() => location.reload(), 1500);
        } else {
            showNotification('error', 'Error', response.error || 'Error al actualizar la reserva');
        }
    })
    .fail(function() {
        showNotification('error', 'Error', 'Error de conexi√≥n al actualizar la reserva');
    })
    .always(function() {
        hideLoading();
    });
}

// Funciones para gestionar ajustes de precio
function abrirModalAjustes() {
    cargarAjustesExistentes();
    $('#modalAjustes').modal('show');
}

function toggleTipoValor() {
    const tipoValor = document.getElementById('tipo_valor').value;
    const campoMonto = document.getElementById('campo_monto');
    const campoPorcentaje = document.getElementById('campo_porcentaje');
    
    if (tipoValor === 'porcentaje') {
        campoMonto.style.display = 'none';
        campoPorcentaje.style.display = 'block';
        document.getElementById('monto_ajuste').removeAttribute('required');
        document.getElementById('porcentaje_ajuste').setAttribute('required', 'required');
    } else {
        campoMonto.style.display = 'block';
        campoPorcentaje.style.display = 'none';
        document.getElementById('monto_ajuste').setAttribute('required', 'required');
        document.getElementById('porcentaje_ajuste').removeAttribute('required');
    }
}

function agregarAjuste() {
    const tipoAjuste = document.getElementById('tipo_ajuste').value;
    const concepto = document.getElementById('concepto_ajuste').value;
    const tipoValor = document.getElementById('tipo_valor').value;
    const monto = document.getElementById('monto_ajuste').value;
    const porcentaje = document.getElementById('porcentaje_ajuste').value;
    
    if (!tipoAjuste || !concepto) {
        showNotification('warning', 'Datos incompletos', 'Por favor complete todos los campos requeridos');
        return;
    }
    
    if (tipoValor === 'monto' && (!monto || parseFloat(monto) <= 0)) {
        showNotification('warning', 'Monto inv√°lido', 'El monto debe ser mayor a 0');
        return;
    }
    
    if (tipoValor === 'porcentaje' && (!porcentaje || parseFloat(porcentaje) <= 0)) {
        showNotification('warning', 'Porcentaje inv√°lido', 'El porcentaje debe ser mayor a 0');
        return;
    }

    const data = {
        hospedada_id: {{ hospedada.id }},
        tipo: tipoAjuste,
        concepto: concepto,
        es_porcentaje: tipoValor === 'porcentaje',
        monto: tipoValor === 'monto' ? parseFloat(monto) : 0.01,
        porcentaje: tipoValor === 'porcentaje' ? parseFloat(porcentaje) : null
    };
    
    showLoading();
    $.post('{% url "hotel:api_agregar_ajuste" %}', JSON.stringify(data), 'json')
    .done(function(response) {
        if (response.success) {
            showNotification('success', 'Ajuste agregado', 'El ajuste se ha aplicado correctamente');
            document.getElementById('formAjuste').reset();
            toggleTipoValor(); // Resetear campos
            cargarAjustesExistentes();
            // Recargar la p√°gina para actualizar totales
            setTimeout(() => location.reload(), 1500);
        } else {
            showNotification('error', 'Error', response.error || 'Error al agregar el ajuste');
        }
    })
    .fail(function() {
        showNotification('error', 'Error', 'Error de conexi√≥n al agregar el ajuste');
    })
    .always(function() {
        hideLoading();
    });
}

function cargarAjustesExistentes() {
    const listaAjustes = document.getElementById('listaAjustes');
    
    // Obtener ajustes desde el contexto de Django
    const ajustes = JSON.parse('{{ ajustes_json|escapejs }}');
    
    if (ajustes.length === 0) {
        listaAjustes.innerHTML = '<p class="text-muted text-center">No hay ajustes aplicados</p>';
        return;
    }
    
    let html = '';
    ajustes.forEach(function(ajuste) {
        const tipoClass = ajuste.tipo === 'extra' ? 'success' : 'danger';
        const signo = ajuste.tipo === 'extra' ? '+' : '-';
        const valor = ajuste.es_porcentaje ? `${ajuste.porcentaje}%` : `$${ajuste.monto_calculado.toFixed(2)}`;
        
        html += `
            <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-2">
                <div>
                    <strong class="text-${tipoClass}">${signo}${valor}</strong>
                    <span class="ms-2">${ajuste.concepto}</span>
                    <small class="text-muted d-block">${ajuste.fecha_creacion}</small>
                </div>
                <button class="btn btn-sm btn-outline-danger" onclick="eliminarAjuste(${ajuste.id})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
    });
    
    listaAjustes.innerHTML = html;
}

function eliminarAjuste(ajusteId) {
    Swal.fire({
        title: '¬øEliminar ajuste?',
        text: 'Esta acci√≥n no se puede deshacer',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'S√≠, eliminar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            const data = { ajuste_id: ajusteId };
            
            showLoading();
            $.post('{% url "hotel:api_eliminar_ajuste" %}', JSON.stringify(data), 'json')
            .done(function(response) {
                if (response.success) {
                    showNotification('success', 'Ajuste eliminado', 'El ajuste se ha eliminado correctamente');
                    cargarAjustesExistentes();
                    // Recargar la p√°gina para actualizar totales
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showNotification('error', 'Error', response.error || 'Error al eliminar el ajuste');
                }
            })
            .fail(function() {
                showNotification('error', 'Error', 'Error de conexi√≥n al eliminar el ajuste');
            })
            .always(function() {
                hideLoading();
            });
        }
    });
}
</script>

<!-- Modal Extender/Definir Fecha de Salida -->
<div class="modal fade" id="modalExtenderReserva" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="tituloModalExtender">
                    <i class="fas fa-calendar-plus text-primary me-2"></i>
                    <span id="textoTitulo">Extender Reserva</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formExtenderReserva">
                    <div class="mb-3">
                        <label class="form-label">Nueva Fecha de Salida</label>
                        <input type="date" class="form-control" id="nueva_fecha_salida" required>
                        <small class="text-muted">Seleccione la nueva fecha de salida para la reserva</small>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Fecha actual de entrada:</strong> {{ hospedada.fecha_entrada|date:"d/m/Y" }}<br>
                        {% if hospedada.fecha_salida %}
                        <strong>Fecha actual de salida:</strong> {{ hospedada.fecha_salida|date:"d/m/Y" }}
                        {% else %}
                        <strong>Estado actual:</strong> Reserva indefinida
                        {% endif %}
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarExtension()">
                    <i class="fas fa-save me-1"></i><span id="textoBoton">Extender Reserva</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Gestionar Ajustes de Precio -->
<div class="modal fade" id="modalAjustes" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-calculator text-success me-2"></i>
                    Gestionar Ajustes de Precio
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Formulario para agregar ajuste -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">Agregar Nuevo Ajuste</h6>
                    </div>
                    <div class="card-body">
                        <form id="formAjuste">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Tipo de Ajuste</label>
                                    <select class="form-select" id="tipo_ajuste" required>
                                        <option value="">Seleccionar tipo</option>
                                        <option value="extra">Cargo Extra</option>
                                        <option value="descuento">Descuento</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Concepto</label>
                                    <input type="text" class="form-control" id="concepto_ajuste" placeholder="Ej: Servicio de limpieza, Descuento por estad√≠a larga" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Tipo de Valor</label>
                                    <select class="form-select" id="tipo_valor" onchange="toggleTipoValor()">
                                        <option value="monto">Monto Fijo</option>
                                        <option value="porcentaje">Porcentaje</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3" id="campo_monto">
                                    <label class="form-label">Monto ($)</label>
                                    <input type="number" class="form-control" id="monto_ajuste" step="0.01" min="0.01">
                                </div>
                                <div class="col-md-4 mb-3" id="campo_porcentaje" style="display: none;">
                                    <label class="form-label">Porcentaje (%)</label>
                                    <input type="number" class="form-control" id="porcentaje_ajuste" step="0.01" min="0.01" max="100">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="button" class="btn btn-success w-100" onclick="agregarAjuste()">
                                        <i class="fas fa-plus me-1"></i>Agregar Ajuste
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Lista de ajustes existentes -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Ajustes Aplicados</h6>
                    </div>
                    <div class="card-body">
                        <div id="listaAjustes">
                            <!-- Se carga din√°micamente -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Servicios -->
<div class="modal fade" id="modalServicios" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-concierge-bell text-primary me-2"></i>
                    Agregar Servicio Adicional
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="tipo_servicio_id" class="form-label">Tipo de Servicio</label>
                            <select class="form-select" id="tipo_servicio_id" required>
                                <option value="">Seleccione un servicio...</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="cantidad_servicio" class="form-label">Cantidad</label>
                            <input type="number" class="form-control" id="cantidad_servicio" value="1" min="1" required>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="precio_servicio" class="form-label">Precio</label>
                            <input type="number" class="form-control" id="precio_servicio" step="0.01" min="0" required>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="observaciones_servicio" class="form-label">Observaciones</label>
                    <textarea class="form-control" id="observaciones_servicio" rows="2"></textarea>
                </div>
                <div class="alert alert-info">
                    <small>
                        <i class="fas fa-info-circle"></i> 
                        El precio puede ser ajustado manualmente seg√∫n el servicio prestado.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="agregarServicio()">
                    <i class="fas fa-plus"></i> Agregar Servicio
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Checkout -->
<div class="modal fade" id="modalCheckout" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-sign-out-alt text-warning me-2"></i>
                    Check-out de Hospedada
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Informaci√≥n de la hospedada -->
                <div class="alert alert-info">
                    <h6>Informaci√≥n de la Hospedada</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Cliente:</strong> {{ hospedada.cliente.nombre_completo }}<br>
                            {% if hospedada.empresa %}
                            <strong>Empresa:</strong> {{ hospedada.empresa.nombre }}<br>
                            {% endif %}
                            <strong>Habitaci√≥n:</strong> {{ hospedada.habitacion.numero }}
                        </div>
                        <div class="col-md-6">
                            <strong>Entrada:</strong> {{ hospedada.fecha_entrada|date:"d/m/Y" }}<br>
                            <strong>Salida:</strong> {{ hospedada.fecha_salida|date:"d/m/Y"|default:"Hoy" }}<br>
                            <strong>Total:</strong> ${{ hospedada.total_con_ajustes|floatformat:2 }}
                        </div>
                    </div>
                </div>

                <!-- Saldo pendiente -->
                <div class="alert alert-warning">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Saldo Pendiente: <span id="saldoPendienteCheckout">${{ hospedada.saldo_pendiente|floatformat:2 }}</span>
                    </h5>
                </div>

                <!-- Opciones si hay deuda -->
                <div id="opcionesCheckout" style="display: none;">
                    <h6>¬øQu√© desea hacer con el saldo pendiente?</h6>
                    
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="accionCheckout" id="pagarTodo" value="pagar_todo" checked>
                        <label class="form-check-label" for="pagarTodo">
                            <strong>Pagar todo ahora</strong> - El cliente/empresa paga el saldo completo
                        </label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="radio" name="accionCheckout" id="dejarDeuda" value="dejar_deuda">
                        <label class="form-check-label" for="dejarDeuda">
                            <strong>Dejar como deuda</strong> - Se registrar√° el monto pendiente
                        </label>
                    </div>

                    <!-- Opciones adicionales -->
                    <div class="row mt-3">
                        <div class="col-md-6" id="opcionDeudor" {% if not hospedada.empresa %}style="display:none;"{% endif %}>
                            <label class="form-label">¬øQui√©n asume el pago/deuda?</label>
                            <select class="form-select" id="deudorCheckout">
                                <option value="cliente">Cliente</option>
                                {% if hospedada.empresa %}
                                <option value="empresa">Empresa ({{ hospedada.empresa.nombre }})</option>
                                {% endif %}
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">M√©todo de pago (si paga todo)</label>
                            <select class="form-select" id="metodoPagoCheckout">
                                <option value="efectivo">Efectivo</option>
                                <option value="tarjeta_credito">Tarjeta de Cr√©dito</option>
                                <option value="tarjeta_debito">Tarjeta de D√©bito</option>
                                <option value="transferencia">Transferencia</option>
                            </select>
                        </div>
                    </div>

                    <div class="mt-3">
                        <label class="form-label">Observaciones sobre la deuda (opcional)</label>
                        <textarea class="form-control" id="observacionesDeuda" rows="2" 
                                  placeholder="Ej: Se enviar√° factura, pago a 30 d√≠as, etc."></textarea>
                    </div>
                </div>

                <!-- Mensaje si no hay deuda -->
                <div id="sinDeudaCheckout" style="display: none;">
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>Sin saldo pendiente</strong> - La hospedada est√° completamente pagada
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="procesarCheckout()">
                    <i class="fas fa-sign-out-alt me-1"></i>Confirmar Check-out
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}